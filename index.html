<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Codere Poker — App Unificada</title>
<style>
  :root{--bg:#0b0f16;--panel:#121826;--muted:#9fb3c8;--text:#e6eef7;--brand:#00e0a4;--danger:#ff5678;--warn:#f6b73c;--ok:#4ade80;--card:#0f1624;--border:#23324b}
  *{box-sizing:border-box} html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,#09101a,#0b0f16 40%,#0b0f16);color:var(--text)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.2) blur(8px);background:rgba(9,16,26,.7);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:auto;padding:16px} .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  h1{margin:0;display:flex;gap:10px;align-items:center} .badge{background:linear-gradient(90deg,#00e0a4,#38bdf8);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800}
  nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px} nav button{background:transparent;border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer}
  nav button.active, .btn.primary{background:var(--brand);color:#03221a;border-color:#07a178}
  main{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  aside,.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  label{display:block;font-size:.9rem;color:var(--muted);margin:.4rem 0} input,select{width:100%;padding:10px;border-radius:10px;background:#0b1321;border:1px solid #20304a;color:var(--text)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .chips{display:flex;flex-wrap:wrap;gap:6px}.chip{display:inline-flex;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:.75rem;color:var(--muted)}
  .tag{font-size:.75rem;color:#fff;background:#071120;border:1px solid #20324e;padding:2px 8px;border-radius:999px}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0d1a2b;color:var(--text);cursor:pointer}
  .muted{color:var(--muted)} .qrbox{display:flex;align-items:center;justify-content:center;min-height:80px;border:1px dashed #38506f;border-radius:12px;background:#0b1321;color:#75a2d6}
  .seatmap{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}.seat{background:#0f1624;border:1px solid #23324b;border-radius:10px;padding:8px}.seat.free{outline:1px solid #0ea5e9}.seat.taken{background:#12223a}
  .alert{padding:10px;border-radius:10px;border:1px solid #30507a;background:#0b1a2b;color:#cbe2ff}.alert.warn{background:#241a07;border-color:#8f6b1e;color:#ffe9b4}.alert.danger{background:#2b0b16;border-color:#7a2035;color:#ffc0ce}
  @media (max-width:960px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>Codere Poker <span class="badge">App Unificada</span></h1>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="role">
          <option value="cliente">Cliente</option>
          <option value="staff">Staff</option>
          <option value="td">TD</option>
        </select>
        <button class="btn" id="applyRole">Acceder</button>
      </div>
    </div>
    <nav>
      <button id="tab-reserva" class="active" onclick="show('reserva')">Reserva</button>
      <button id="tab-checkin" onclick="show('checkin')" hidden>Check-in</button>
      <button id="tab-td" onclick="show('td')" hidden>Panel TD</button>
    </nav>
  </div>
</header>

<main>
  <aside>
    <h3>Perfil</h3>
    <label>Nombre <input id="pName" placeholder="Ej: Juan Pérez"></label>
    <div class="two">
      <label>País <input id="pCountry" placeholder="MX"></label>
      <label>Contacto <input id="pContact" placeholder="WhatsApp o email"></label>
    </div>
    <label><input id="p18" type="checkbox"> Soy mayor de 18 años</label>
    <label><input id="pRG" type="checkbox"> No estoy autoexcluido</label>
    <button class="btn primary" id="saveProfile">Guardar perfil</button>

    <hr style="border-color:#20324e;margin:14px 0">
    <h3>Filtros</h3>
    <label>Fecha <input type="date" id="fDate"></label>
    <label>Modalidad
      <select id="fType">
        <option value="">Todas</option><option>freezeout</option><option>pko</option><option>rebuy-addon</option><option>satellite</option><option>multi-day</option><option>turbo</option>
      </select>
    </label>
    <div class="two">
      <label>Buy-in mín <input type="number" id="fMin" min="0"></label>
      <label>Buy-in máx <input type="number" id="fMax" min="0"></label>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="btnClear">Limpiar</button>
      <button class="btn primary" id="btnApply">Aplicar</button>
    </div>
  </aside>

  <!-- RESERVA -->
  <section class="panel" id="reserva">
    <h2>Reserva online (pago en sala)</h2>
    <div id="cards" class="grid"></div>

    <div style="margin-top:16px">
      <h3>Mis reservas</h3>
      <div id="myRegs"></div>
    </div>
  </section>

  <!-- CHECK-IN (STAFF) -->
  <section class="panel" id="checkin" hidden>
    <h2>Check-in</h2>
    <label>REG / Ticket <input id="qrInput" placeholder="REG-xxxx-xxxx"></label>
    <button class="btn" id="doCheckin">Check-in</button>
    <div id="checkinResult" class="alert" style="margin-top:10px" hidden></div>
  </section>

  <!-- TD -->
  <section class="panel" id="td" hidden>
    <h2>Panel TD</h2>
    <label>Torneo <select id="tdTournament"></select></label>
    <div id="seatmap" class="seatmap" style="margin-top:10px"></div>
  </section>
</main>

<script>
const API = { base: location.origin + '/api' };
const el = id => document.getElementById(id);
const money = (v,c="MXN") => new Intl.NumberFormat('es-MX',{style:'currency',currency:c,maximumFractionDigits:0}).format(v);
const state = { role:'cliente', profile:null, tournaments:[] };

function show(view){
  ['reserva','checkin','td'].forEach(id=>el(id).hidden = id!==view);
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  el('tab-'+view).classList.add('active');
}

function applyRole(){
  state.role = el('role').value;
  el('tab-checkin').hidden = state.role==='cliente';
  el('tab-td').hidden = !(state.role==='td');
  // auto volver a Reserva si ya no tienes permiso
  if(state.role==='cliente') show('reserva');
}

function loadProfile(){
  try{ const s=localStorage.getItem('clientProfile'); if(!s) return;
    const p=JSON.parse(s); state.profile=p;
    el('pName').value=p.name||''; el('pCountry').value=p.country||''; el('pContact').value=p.contact||'';
    el('p18').checked=!!p.adult; el('pRG').checked=!!p.rgok;
  }catch{}
}
function saveProfile(){
  const name=el('pName').value.trim(), country=el('pCountry').value.trim()||'MX', contact=el('pContact').value.trim();
  const adult=el('p18').checked, rgok=el('pRG').checked;
  const pid = name? name.toLowerCase().replace(/\s+/g,'-') : `player-${Math.random().toString(36).slice(2,8)}`;
  const p={id:pid,name,country,contact,adult,rgok}; localStorage.setItem('clientProfile', JSON.stringify(p)); state.profile=p; alert('Perfil guardado');
}

async function fetchTournaments(){
  const r = await fetch(`${API.base}/tournaments`); state.tournaments = await r.json(); renderList(); fillTdSelect();
}
function resetFilters(){ el('fDate').value=""; el('fType').value=""; el('fMin').value=""; el('fMax').value=""; renderList(); }
function applyFilters(){ renderList(); }

function renderList(){
  const box = el('cards'); box.innerHTML='';
  const f = { date:el('fDate').value, type:el('fType').value, min:el('fMin').value, max:el('fMax').value };
  const items = state.tournaments.filter(t=>{
    const d=new Date(t.date_start);
    if(f.date){const fd=new Date(f.date); if(d.toDateString()!=fd.toDateString()) return false}
    if(f.type && !t.type.includes(f.type)) return false;
    const total = t.buyin.amount + (t.buyin.fee||0) + (t.buyin.bounty||0);
    if(f.min && total < +f.min) return false;
    if(f.max && total > +f.max) return false;
    return true;
  }).sort((a,b)=>new Date(a.date_start)-new Date(b.date_start));
  items.forEach(t=>{
    const total = t.buyin.amount + (t.buyin.fee||0) + (t.buyin.bounty||0);
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="row"><h3 style="margin:0">${t.title}</h3><span class="tag">${new Date(t.date_start).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'})}</span></div>
      <div class="chips">${t.type.map(x=>`<span class="chip">${x}</span>`).join('')}
        <span class="chip">cap ${t.capacity}</span><span class="chip">late reg L${t.late_reg_end_level}</span></div>
      <div class="two">
        <div class="muted">Buy-in ${money(t.buyin.amount)} ${t.buyin.fee?'+ fee '+money(t.buyin.fee):''} ${t.buyin.bounty?'+ bounty '+money(t.buyin.bounty):''}</div>
        <div class="muted">Stack inicial ${t.stack.initial.toLocaleString()} fichas</div>
      </div>
      <div class="row"><button class="btn" onclick='reserve("${t.id}")'>Reservar</button></div>`;
    box.appendChild(div);
  });
  renderMyRegs();
}

async function reserve(tid){
  const t = state.tournaments.find(x=>x.id===tid);
  const p = state.profile;
  if(!p){ alert('Guarda tu perfil primero.'); return; }
  if(!p.adult) return alert('Debes ser mayor de 18.');
  if(!p.rgok) return alert('No puedes reservar si estás autoexcluido.');
  try{
    const resp = await fetch(`${API.base}/reserve`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ tournamentId: t.id, qty:1, player:{ id:p.id || p.name.toLowerCase().replace(/\s+/g,'-'), name:p.name||'Cliente' } })
    });
    const data = await resp.json(); if(!resp.ok) throw new Error(data.error||'Error');
    const r = data.regs[0];
    alert(`Reserva creada: ${r.id} — ${r.seat_id ? `Mesa ${r.seat_id.split('-')[0]} S${r.seat_id.split('-')[1]}` : 'Waitlist'}`);
    // guarda local
    const my = JSON.parse(localStorage.getItem('myRegs')||'[]');
    my.push({ id:r.id, tournament:t.title, date:t.date_start, seat:r.seat_id });
    localStorage.setItem('myRegs', JSON.stringify(my));
    renderMyRegs();
  }catch(e){ alert('No se pudo reservar: '+e.message); }
}

function renderMyRegs(){
  const box = el('myRegs'); const list = JSON.parse(localStorage.getItem('myRegs')||'[]');
  if(!list.length){ box.innerHTML = '<div class="muted">Sin reservas aún.</div>'; return; }
  box.innerHTML = '<div class="grid">'+ list.slice().reverse().map(r=>{
    const seat = r.seat ? `• Mesa ${r.seat.split('-')[0]} • S${r.seat.split('-')[1]}` : '• (waitlist)';
    return `<div class="card"><div class="row"><h4 style="margin:0">${r.tournament}</h4>
    <span class="tag">${new Date(r.date).toLocaleDateString('es-MX',{weekday:'short',hour:'2-digit',minute:'2-digit'})}</span></div>
    <div class="muted">REG: <b>${r.id}</b> ${seat}</div></div>`;
  }).join('') + '</div>';
}

// Staff check-in
async function doCheckin(){
  const code = el('qrInput').value.trim(); const box=el('checkinResult');
  if(!code){ box.hidden=false; box.className='alert danger'; box.textContent='Ingresa un REG.'; return; }
  try{
    const resp = await fetch(`${API.base}/checkin`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({regId:code}) });
    const data = await resp.json(); if(!resp.ok) throw new Error(data.error||'Error');
    const r = data.reg; const [mesa,silla] = (r.seat_id||'- -').split('-');
    box.hidden=false; box.className='alert'; box.textContent = `Check-in OK. Mesa ${mesa} • S${silla} (REG ${r.id})`;
  }catch(e){
    box.hidden=false; box.className='alert danger'; box.textContent='Error: '+e.message;
  }
}

// TD seatmap
async function fillTdSelect(){
  const sel = el('tdTournament'); sel.innerHTML='';
  state.tournaments.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=`${t.title} (${t.venue})`; sel.appendChild(o); });
  sel.onchange = renderSeatmap;
  if(state.tournaments.length){ sel.value = state.tournaments[0].id; renderSeatmap(); }
}
async function renderSeatmap(){
  const tid = el('tdTournament').value;
  const res = await fetch(`${API.base}/seatmap/${tid}`); const j = await res.json();
  const box = el('seatmap'); box.innerHTML='';
  j.grid.forEach(row=>{
    row.forEach(seat=>{
      const d=document.createElement('div'); d.className='seat ' + (seat.regId?'taken':'free');
      d.innerHTML = `<div>M${seat.table} • S${seat.seat}</div><div class="muted">${seat.regId||'Libre'}</div>`;
      box.appendChild(d);
    });
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadProfile();
  fetchTournaments();
  el('applyRole').onclick = applyRole;
  el('saveProfile').onclick = saveProfile;
  el('btnClear').onclick = resetFilters;
  el('btnApply').onclick = applyFilters;
  el('doCheckin').onclick = doCheckin;
});
</script>
</body>
</html>
